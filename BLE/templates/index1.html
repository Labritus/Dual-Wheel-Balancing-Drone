<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WHEELTEC BLE Control with People Detection</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      text-align: center; 
      padding: 20px; 
      max-width: 1200px;
      margin: 0 auto;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .control-panel {
      flex: 1;
      min-width: 300px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      background-color: #f8f8f8;
    }
    .video-panel {
      flex: 1;
      min-width: 320px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      background-color: #f8f8f8;
    }
    button { 
      margin: 10px; 
      padding: 15px 30px; 
      font-size: 18px; 
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
    }
    #controls { 
      margin-top: 20px; 
      display: none; 
    }
    input[type=range] { 
      width: 300px; 
      margin: 10px 0;
    }
    #joystickContainer {
      margin: 20px auto;
      position: relative;
      width: 200px; height: 200px;
      background: #f0f0f0; border-radius: 50%;
      touch-action: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #thumb {
      position: absolute;
      width: 50px; height: 50px;
      background: #555; border-radius: 50%;
      top: 75px; left: 75px;
      transition: top 0.1s, left 0.1s;
      touch-action: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #videoFeed {
      max-width: 100%;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #status, #connectionStatus {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .not-connected {
      background-color: #ffecec;
      color: #f44336;
    }
    .connected {
      background-color: #e7f6e7;
      color: #4CAF50;
    }
    .stats {
      font-size: 14px;
      text-align: left;
      margin: 10px 0;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
    }
    h1, h2 {
      color: #333;
    }
  </style>
</head>
<body>

  <h1>WHEELTEC Car Control with People Detection</h1>
  
  <div class="container">
    <div class="control-panel">
      <h2>Car Control</h2>
      <button id="connectBtn" onclick="connect()">Connect Car</button>
      <div id="status" class="not-connected">Not Connected</div>

      <div id="controls">
        <h2>Speed Control</h2>
        <input type="range" id="speed" min="0" max="100" value="50" onchange="setSpeed()"/>
        <div>Current Speed: <span id="speedValue">50</span></div>

        <h2>Joystick Control</h2>
        <div id="joystickContainer">
          <div id="thumb"></div>
        </div>
        <div>Drag the joystick to move, release to stop</div>
      </div>
    </div>

    <div class="video-panel">
      <h2>People Detection</h2>
      <button id="videoBtn" onclick="toggleVideo()">Start Detection</button>
      <div id="connectionStatus" class="not-connected">Video Not Connected</div>
      <canvas id="videoFeed" width="320" height="240"></canvas>
      <div class="stats">
        <div>Detected People: <span id="peopleCount">0</span></div>
        <div>FPS: <span id="fps">0</span></div>
        <div>Last Update: <span id="lastUpdate">Never</span></div>
      </div>
    </div>
  </div>

  <script>
    // Bluetooth control variables
    let device, server, service, writeCharacteristic, speedCharacteristic;
    const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
    const CMD_CHAR    = '0000ffe1-0000-1000-8000-00805f9b34fb';
    
    // Video and WebSocket variables
    let ws = null;
    let videoActive = false;
    const canvas = document.getElementById('videoFeed');
    const ctx = canvas.getContext('2d');
    let lastFrameTime = 0;
    let frameCount = 0;
    let lastFpsUpdate = 0;
    
    // Connect to the car via Bluetooth
    async function connect() {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });
        server = await device.gatt.connect();
        service = await server.getPrimaryService(SERVICE_UUID);
        writeCharacteristic = await service.getCharacteristic(CMD_CHAR);
        // optional speed char
        try {
          speedCharacteristic = await service.getCharacteristic('0000ffe2-0000-1000-8000-00805f9b34fb');
        } catch {}
        
        const statusEl = document.getElementById("status");
        statusEl.innerText = "Connected";
        statusEl.className = "connected";
        document.getElementById("controls").style.display = "block";
        document.getElementById("connectBtn").disabled = true;
      } catch (e) {
        alert("Connection failed: " + e);
      }
    }

    async function sendCommand(code) {
      if (!writeCharacteristic) return;
      await writeCharacteristic.writeValue(Uint8Array.of(code));
    }

    function setSpeed() {
      const v = parseInt(document.getElementById("speed").value);
      document.getElementById("speedValue").innerText = v;
      if (speedCharacteristic) {
        speedCharacteristic.writeValue(Uint8Array.of(v));
      }
    }

    // --- Joystick logic ---
    const thumb = document.getElementById('thumb');
    const container = document.getElementById('joystickContainer');
    const maxDist = 75; // px
    let active = false;
    let lastDir = 0x00;

    function getDirectionCode(x, y) {
      const angle = Math.atan2(-y, x) * 180 / Math.PI; // -y so up is positive
      const mag = Math.hypot(x, y);
      if (mag < 20) return 0x00; // deadzone = stop

      // map angle to one of 8
      if (angle >= 67.5 && angle < 112.5) return 0x41; // forward
      if (angle >= 22.5 && angle < 67.5) return 0x42;  // forward-right
      if (angle >= -22.5 && angle < 22.5) return 0x43; // right
      if (angle >= -67.5 && angle < -22.5) return 0x44; // backward-right
      if (angle >= -112.5 && angle < -67.5) return 0x45; // backward
      if (angle >= -157.5 && angle < -112.5) return 0x46;// backward-left
      if (angle >= 112.5 || angle < -157.5) return 0x47; // left
      if (angle >= 67.5 && angle < 112.5) return 0x48;   // forward-left
      return 0x00;
    }

    function pointerDown(evt) {
      active = true;
      moveThumb(evt);
      container.setPointerCapture(evt.pointerId);
    }

    function pointerMove(evt) {
      if (!active) return;
      moveThumb(evt);
    }

    function pointerUp(evt) {
      active = false;
      thumb.style.top = '75px';
      thumb.style.left = '75px';
      if (lastDir !== 0x00) {
        sendCommand(0x00);
        lastDir = 0x00;
      }
      container.releasePointerCapture(evt.pointerId);
    }

    function moveThumb(evt) {
      const rect = container.getBoundingClientRect();
      const x = evt.clientX - rect.left - rect.width/2;
      const y = evt.clientY - rect.top - rect.height/2;
      const dist = Math.min(maxDist, Math.hypot(x,y));
      const angle = Math.atan2(y, x);
      const nx = dist * Math.cos(angle);
      const ny = dist * Math.sin(angle);
      thumb.style.left = `${100 + nx - 25}px`;
      thumb.style.top  = `${100 + ny - 25}px`;

      const dir = getDirectionCode(nx, ny);
      if (dir !== lastDir) {
        sendCommand(dir);
        lastDir = dir;
      }
    }

    container.addEventListener('pointerdown', pointerDown);
    container.addEventListener('pointermove', pointerMove);
    container.addEventListener('pointerup',   pointerUp);
    container.addEventListener('pointerleave', pointerUp);

    // --- Video stream and people detection ---
    function toggleVideo() {
      if (videoActive) {
        stopVideo();
      } else {
        startVideo();
      }
    }

    function startVideo() {
      if (ws) {
        ws.close();
      }
      
      // Create WebSocket connection to the backend
      ws = new WebSocket(`ws://${window.location.hostname}:8765`);
      
      ws.onopen = function() {
        videoActive = true;
        document.getElementById('videoBtn').textContent = 'Stop Detection';
        document.getElementById('connectionStatus').innerText = 'Connected';
        document.getElementById('connectionStatus').className = 'connected';
        console.log('WebSocket connection established');
        
        // Request first frame
        ws.send(JSON.stringify({command: 'start_stream'}));
      };
      
      ws.onmessage = function(event) {
        // Handle data received from WebSocket
        if (typeof event.data === 'string') {
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'stats') {
              document.getElementById('peopleCount').innerText = data.people_count;
              document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
            }
          } catch (e) {
            console.error('Error parsing JSON message:', e);
          }
        } else if (event.data instanceof Blob) {
          // Handle image data
          const reader = new FileReader();
          reader.onload = function() {
            const img = new Image();
            img.onload = function() {
              // Draw the image to canvas
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              
              // Update FPS
              const now = performance.now();
              frameCount++;
              
              if (now - lastFpsUpdate >= 1000) { // Update FPS every second
                document.getElementById('fps').innerText = Math.round(frameCount * 1000 / (now - lastFpsUpdate));
                frameCount = 0;
                lastFpsUpdate = now;
              }
              
              lastFrameTime = now;
              
              // Request next frame
              if (videoActive) {
                ws.send(JSON.stringify({command: 'next_frame'}));
              }
            };
            img.src = reader.result;
          };
          reader.readAsDataURL(event.data);
        }
      };
      
      ws.onclose = function() {
        console.log('WebSocket connection closed');
        videoActive = false;
        document.getElementById('videoBtn').textContent = 'Start Detection';
        document.getElementById('connectionStatus').innerText = 'Video Not Connected';
        document.getElementById('connectionStatus').className = 'not-connected';
      };
      
      ws.onerror = function(error) {
        console.error('WebSocket error:', error);
        alert('Error connecting to video stream. Please check that the backend server is running.');
        videoActive = false;
        document.getElementById('videoBtn').textContent = 'Start Detection';
        document.getElementById('connectionStatus').innerText = 'Connection Error';
        document.getElementById('connectionStatus').className = 'not-connected';
      };
    }
    
    function stopVideo() {
      if (ws) {
        ws.send(JSON.stringify({command: 'stop_stream'}));
        ws.close();
        ws = null;
      }
      videoActive = false;
      document.getElementById('videoBtn').textContent = 'Start Detection';
      document.getElementById('connectionStatus').innerText = 'Video Not Connected';
      document.getElementById('connectionStatus').className = 'not-connected';
    }
    
    // Clean up when page is unloaded
    window.addEventListener('beforeunload', function() {
      if (ws) {
        ws.close();
      }
    });
  </script>

</body>
</html>