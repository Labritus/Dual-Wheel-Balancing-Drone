<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WHEELTEC BLE Control with Joystick</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { margin: 10px; padding: 15px 30px; font-size: 18px; }
    #controls { margin-top: 20px; display: none; }
    input[type=range] { width: 300px; }
    #joystickContainer {
      margin: 20px auto;
      position: relative;
      width: 200px; height: 200px;
      background: #f0f0f0; border-radius: 50%;
      touch-action: none;
    }
    #thumb {
      position: absolute;
      width: 50px; height: 50px;
      background: #888; border-radius: 50%;
      top: 75px; left: 75px;
      transition: top 0.1s, left 0.1s;
      touch-action: none;
    }
  </style>
</head>
<body>

  <h1>WHEELTEC Car Bluetooth Control</h1>
  <button onclick="connect()">Connect Car</button>
  <div id="status">Not Connected</div>

  <div id="controls">
    <h2>Speed Control</h2>
    <input type="range" id="speed" min="0" max="100" value="50" onchange="setSpeed()"/>
    <div>Current Speed: <span id="speedValue">50</span></div>

    <h2>Joystick Control</h2>
    <div id="joystickContainer">
      <div id="thumb"></div>
    </div>
    <div>Drag the joystick to move, release to stop</div>
  </div>

  <script>
    let device, server, service, writeCharacteristic, speedCharacteristic;
    const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
    const CMD_CHAR    = '0000ffe1-0000-1000-8000-00805f9b34fb';

    async function connect() {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });
        server = await device.gatt.connect();
        service = await server.getPrimaryService(SERVICE_UUID);
        writeCharacteristic = await service.getCharacteristic(CMD_CHAR);
        // optional speed char
        try {
          speedCharacteristic = await service.getCharacteristic('0000ffe2-0000-1000-8000-00805f9b34fb');
        } catch {}
        document.getElementById("status").innerText = "Connected";
        document.getElementById("controls").style.display = "block";
      } catch (e) {
        alert("Connection failed: " + e);
      }
    }

    async function sendCommand(code) {
      if (!writeCharacteristic) return;
      await writeCharacteristic.writeValue(Uint8Array.of(code));
    }

    function setSpeed() {
      const v = parseInt(document.getElementById("speed").value);
      document.getElementById("speedValue").innerText = v;
      if (speedCharacteristic) {
        speedCharacteristic.writeValue(Uint8Array.of(v));
      }
    }

    // --- Joystick logic ---
    const thumb = document.getElementById('thumb');
    const container = document.getElementById('joystickContainer');
    const maxDist = 75; // px
    let active = false;
    let lastDir = 0x00;

    function getDirectionCode(x, y) {
      const angle = Math.atan2(-y, x) * 180 / Math.PI; // -y so up is positive
      const mag = Math.hypot(x, y);
      if (mag < 20) return 0x00; // deadzone = stop

      // map angle to one of 8
      if (angle >= 67.5 && angle < 112.5) return 0x41; // forward
      if (angle >= 22.5 && angle < 67.5) return 0x42;  // forward-right
      if (angle >= -22.5 && angle < 22.5) return 0x43; // right
      if (angle >= -67.5 && angle < -22.5) return 0x44; // backward-right
      if (angle >= -112.5 && angle < -67.5) return 0x45; // backward
      if (angle >= -157.5 && angle < -112.5) return 0x46;// backward-left
      if (angle >= 112.5 || angle < -157.5) return 0x47; // left
      if (angle >= 67.5 && angle < 112.5) return 0x48;   // forward-left
      return 0x00;
    }

    function pointerDown(evt) {
      active = true;
      moveThumb(evt);
      container.setPointerCapture(evt.pointerId);
    }

    function pointerMove(evt) {
      if (!active) return;
      moveThumb(evt);
    }

    function pointerUp(evt) {
      active = false;
      thumb.style.top = '75px';
      thumb.style.left = '75px';
      if (lastDir !== 0x00) {
        sendCommand(0x00);
        lastDir = 0x00;
      }
      container.releasePointerCapture(evt.pointerId);
    }

    function moveThumb(evt) {
      const rect = container.getBoundingClientRect();
      const x = evt.clientX - rect.left - rect.width/2;
      const y = evt.clientY - rect.top - rect.height/2;
      const dist = Math.min(maxDist, Math.hypot(x,y));
      const angle = Math.atan2(y, x);
      const nx = dist * Math.cos(angle);
      const ny = dist * Math.sin(angle);
      thumb.style.left = `${100 + nx - 25}px`;
      thumb.style.top  = `${100 + ny - 25}px`;

      const dir = getDirectionCode(nx, ny);
      if (dir !== lastDir) {
        sendCommand(dir);
        lastDir = dir;
      }
    }

    container.addEventListener('pointerdown', pointerDown);
    container.addEventListener('pointermove', pointerMove);
    container.addEventListener('pointerup',   pointerUp);
    container.addEventListener('pointerleave', pointerUp);
  </script>

</body>
</html>
