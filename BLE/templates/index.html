<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WHEELTEC BLE Control with Joystick</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { margin: 10px; padding: 15px 30px; font-size: 18px; }
    #controls { margin-top: 20px; display: none; }
    input[type=range] { width: 300px; }
    #joystickContainer {
      margin: 20px auto;
      position: relative;
      width: 200px; height: 200px;
      background: #f0f0f0; border-radius: 50%;
      touch-action: none;
    }
    #thumb {
      position: absolute;
      width: 50px; height: 50px;
      background: #888; border-radius: 50%;
      top: 75px; left: 75px;
      transition: top 0.1s, left 0.1s;
      touch-action: none;
    }
    #scanResults {
      margin: 10px auto;
      max-width: 500px;
      text-align: left;
      display: none;
    }
    .device-item {
      padding: 10px;
      margin: 5px 0;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
    }
    .device-item:hover {
      background: #e9e9e9;
    }
  </style>
</head>
<body>

  <h1>WHEELTEC Car Bluetooth Control</h1>
  <button id="scanButton">Scan for Cars</button>
  <button id="connectButton" style="display:none;">Connect to Selected</button>
  <div id="status">Not Connected</div>
  
  <div id="scanResults"></div>

  <div id="controls">
    <h2>Speed Control</h2>
    <input type="range" id="speed" min="0" max="100" value="50" onchange="setSpeed()"/>
    <div>Current Speed: <span id="speedValue">50</span></div>

    <h2>Joystick Control</h2>
    <div id="joystickContainer">
      <div id="thumb"></div>
    </div>
    <div>Drag the joystick to move, release to stop</div>
  </div>

  <script>
    // DOM Elements
    const scanButton = document.getElementById('scanButton');
    const connectButton = document.getElementById('connectButton');
    const statusEl = document.getElementById('status');
    const scanResultsEl = document.getElementById('scanResults');
    const controlsEl = document.getElementById('controls');
    const speedEl = document.getElementById('speed');
    const speedValueEl = document.getElementById('speedValue');
    
    // State variables
    let selectedDeviceAddress = null;
    let connected = false;
    let lastDir = 0x00;
    
    // Check if already connected on page load
    window.addEventListener('load', async () => {
      try {
        const response = await fetch('/bluetooth_status');
        const status = await response.json();
        if (status.connected) {
          connected = true;
          statusEl.innerText = `Connected to: ${status.device_address}`;
          controlsEl.style.display = 'block';
        }
      } catch (error) {
        console.error('Error checking connection status:', error);
      }
    });
    
    // Scan for Bluetooth devices
    scanButton.addEventListener('click', async () => {
      try {
        statusEl.innerText = 'Scanning for devices...';
        scanResultsEl.innerHTML = '';
        scanResultsEl.style.display = 'block';
        connectButton.style.display = 'none';
        
        const response = await fetch('/scan_bluetooth');
        const result = await response.json();
        
        if (result.success) {
          if (result.devices.length === 0) {
            scanResultsEl.innerHTML = '<div>No devices found</div>';
          } else {
            statusEl.innerText = `Found ${result.devices.length} devices`;
            
            result.devices.forEach(device => {
              const deviceName = device.name || 'Unknown Device';
              const deviceEl = document.createElement('div');
              deviceEl.className = 'device-item';
              deviceEl.innerText = `${deviceName} (${device.address})`;
              deviceEl.addEventListener('click', () => {
                // Highlight selected device
                document.querySelectorAll('.device-item').forEach(el => {
                  el.style.background = '#f9f9f9';
                });
                deviceEl.style.background = '#d4edda';
                
                selectedDeviceAddress = device.address;
                connectButton.style.display = 'inline-block';
              });
              scanResultsEl.appendChild(deviceEl);
            });
          }
        } else {
          statusEl.innerText = `Scan error: ${result.error}`;
        }
      } catch (error) {
        statusEl.innerText = `Scan failed: ${error.message}`;
        console.error('Scan error:', error);
      }
    });
    
    // Connect to selected device
    connectButton.addEventListener('click', async () => {
      if (!selectedDeviceAddress) {
        statusEl.innerText = 'Please select a device first';
        return;
      }
      
      try {
        statusEl.innerText = `Connecting to ${selectedDeviceAddress}...`;
        
        const response = await fetch('/connect_bluetooth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address: selectedDeviceAddress })
        });
        
        const result = await response.json();
        
        if (result.success) {
          connected = true;
          statusEl.innerText = result.message;
          scanResultsEl.style.display = 'none';
          connectButton.style.display = 'none';
          controlsEl.style.display = 'block';
        } else {
          statusEl.innerText = `Connection error: ${result.error}`;
        }
      } catch (error) {
        statusEl.innerText = `Connection failed: ${error.message}`;
        console.error('Connection error:', error);
      }
    });
    
    // Set speed
    async function setSpeed() {
      if (!connected) return;
      
      const speed = parseInt(speedEl.value);
      speedValueEl.innerText = speed;
      
      try {
        await fetch('/set_speed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ speed: speed })
        });
      } catch (error) {
        console.error('Error setting speed:', error);
      }
    }
    
    // Send command
    async function sendCommand(code) {
      if (!connected) return;
      
      try {
        await fetch('/send_command', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: code })
        });
      } catch (error) {
        console.error('Error sending command:', error);
        // Check if we're still connected if command failed
        checkConnectionStatus();
      }
    }
    
    // Check connection status
    async function checkConnectionStatus() {
      try {
        const response = await fetch('/bluetooth_status');
        const status = await response.json();
        
        if (connected && !status.connected) {
          // Connection was lost
          connected = false;
          statusEl.innerText = 'Connection lost';
          controlsEl.style.display = 'none';
        }
      } catch (error) {
        console.error('Error checking connection:', error);
      }
    }
    
    // --- Joystick logic ---
    const thumb = document.getElementById('thumb');
    const container = document.getElementById('joystickContainer');
    const maxDist = 75; // px
    let active = false;
    
    function getDirectionCode(x, y) {
      const angle = Math.atan2(-y, x) * 180 / Math.PI; // -y so up is positive
      const mag = Math.hypot(x, y);
      if (mag < 20) return 0x00; // deadzone = stop

      // map angle to one of 8
      if (angle >= 67.5 && angle < 112.5) return 0x41; // forward
      if (angle >= 22.5 && angle < 67.5) return 0x42;  // forward-right
      if (angle >= -22.5 && angle < 22.5) return 0x43; // right
      if (angle >= -67.5 && angle < -22.5) return 0x44; // backward-right
      if (angle >= -112.5 && angle < -67.5) return 0x45; // backward
      if (angle >= -157.5 && angle < -112.5) return 0x46;// backward-left
      if (angle >= 112.5 || angle < -157.5) return 0x47; // left
      if (angle >= 67.5 && angle < 112.5) return 0x48;   // forward-left
      return 0x00;
    }

    function pointerDown(evt) {
      active = true;
      moveThumb(evt);
      container.setPointerCapture(evt.pointerId);
    }

    function pointerMove(evt) {
      if (!active) return;
      moveThumb(evt);
    }

    function pointerUp(evt) {
      active = false;
      thumb.style.top = '75px';
      thumb.style.left = '75px';
      if (lastDir !== 0x00) {
        sendCommand(0x00);
        lastDir = 0x00;
      }
      container.releasePointerCapture(evt.pointerId);
    }

    function moveThumb(evt) {
      const rect = container.getBoundingClientRect();
      const x = evt.clientX - rect.left - rect.width/2;
      const y = evt.clientY - rect.top - rect.height/2;
      const dist = Math.min(maxDist, Math.hypot(x,y));
      const angle = Math.atan2(y, x);
      const nx = dist * Math.cos(angle);
      const ny = dist * Math.sin(angle);
      thumb.style.left = `${100 + nx - 25}px`;
      thumb.style.top  = `${100 + ny - 25}px`;

      const dir = getDirectionCode(nx, ny);
      if (dir !== lastDir) {
        sendCommand(dir);
        lastDir = dir;
      }
    }

    container.addEventListener('pointerdown', pointerDown);
    container.addEventListener('pointermove', pointerMove);
    container.addEventListener('pointerup',   pointerUp);
    container.addEventListener('pointerleave', pointerUp);
  </script>

</body>
</html>